<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limn Order Form - Add Order Items</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .order-info-bar {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-info-item {
            display: flex;
            flex-direction: column;
        }

        .order-info-item label {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 5px;
        }

        .order-info-item span {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 600px;
        }

        .left-panel {
            padding: 30px;
            border-right: 2px solid #e0e0e0;
        }

        .right-panel {
            background: #f8f9fa;
            padding: 30px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
            border-radius: 8px;
        }

        .tab:hover {
            background: rgba(103, 126, 234, 0.1);
        }

        .tab.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .price-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .price-display .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .price-display .value {
            font-size: 28px;
            font-weight: bold;
        }

        .order-items-section {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .order-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .order-items-header h3 {
            font-size: 18px;
            color: #333;
        }

        .order-total {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .order-items-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .order-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .order-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .order-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .order-item-sku {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .order-item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
            color: #666;
        }

        .order-item-price {
            text-align: right;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .remove-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all 0.3s;
        }

        .remove-item:hover {
            background: #ff1744;
            transform: scale(1.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .debug {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Add Order Items</h1>
            <p>Configure furniture items for this order</p>
        </div>

        <div class="order-info-bar">
            <div class="order-info-item">
                <label>Order ID</label>
                <span id="order-id">ORD-2025-001</span>
            </div>
            <div class="order-info-item">
                <label>Client</label>
                <span id="client-name">Loading...</span>
            </div>
            <div class="order-info-item">
                <label>Project</label>
                <span id="project-name">Loading...</span>
            </div>
            <div class="order-info-item">
                <label>Created Date</label>
                <span id="order-date">2025-01-01</span>
            </div>
            <div class="order-info-item">
                <label>Status</label>
                <span id="order-status">Draft</span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('basic-info')">Item Details</button>
                    <button class="tab" onclick="switchTab('fabric')" disabled>Fabric</button>
                    <button class="tab" onclick="switchTab('wood')" disabled>Wood</button>
                    <button class="tab" onclick="switchTab('metal')" disabled>Metal</button>
                    <button class="tab" onclick="switchTab('stone')" disabled>Stone</button>
                    <button class="tab" onclick="switchTab('weave')" disabled>Weave</button>
                    <button class="tab" onclick="switchTab('carving')" disabled>Carving</button>
                    <button class="tab" onclick="switchTab('additional')" disabled>Additional</button>
                </div>

                <div id="basic-info" class="tab-content active">
                    <h3>Select Item</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="collection">Collection *</label>
                            <select id="collection" required onchange="loadItems()">
                                <option value="">Loading collections...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item">Item *</label>
                            <select id="item" required disabled onchange="updateItemPrice()">
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="price">Price *</label>
                            <input type="number" id="price" min="0" step="0.01" placeholder="Enter price" required onchange="updateItemPrice()">
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity *</label>
                            <input type="number" id="quantity" min="1" value="1" required onchange="updateItemPrice()">
                        </div>
                        <div class="form-group">
                            <label for="rush">Rush Order</label>
                            <select id="rush" onchange="updateItemPrice()">
                                <option value="no">No</option>
                                <option value="yes">Yes (+25%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="price-display">
                        <div class="label">Item Price</div>
                        <div class="value" id="item-price">$0.00</div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Item Notes</label>
                        <textarea id="notes" placeholder="Special instructions for this item..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="validateBasicInfo()">Continue to Materials</button>
                    </div>
                </div>

                <div id="fabric" class="tab-content">
                    <h3>Select Fabric</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fabric-brand">Fabric Brand</label>
                            <select id="fabric-brand" onchange="loadFabricCollections()">
                                <option value="">Select Brand</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fabric-collection">Fabric Collection</label>
                            <select id="fabric-collection" onchange="loadFabricColors()" disabled>
                                <option value="">Select Collection</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fabric-color">Fabric Color</label>
                            <select id="fabric-color" disabled>
                                <option value="">Select Color</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('basic-info')">Back</button>
                        <button class="btn btn-primary" onclick="switchTab('wood')">Continue</button>
                    </div>
                </div>

                <div id="wood" class="tab-content">
                    <h3>Select Wood</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="wood-type">Wood Type</label>
                            <select id="wood-type" onchange="loadWoodFinishes()">
                                <option value="">Select Wood</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="wood-finish">Wood Finish</label>
                            <select id="wood-finish">
                                <option value="">Select Finish</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('fabric')">Back</button>
                        <button class="btn btn-primary" onclick="switchTab('metal')">Continue</button>
                    </div>
                </div>

                <div id="metal" class="tab-content">
                    <h3>Select Metal</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="metal-type">Metal Type</label>
                            <select id="metal-type" onchange="loadMetalFinishes()">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="metal-finish">Metal Finish</label>
                            <select id="metal-finish">
                                <option value="">Select Finish</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('wood')">Back</button>
                        <button class="btn btn-primary" onclick="switchTab('stone')">Continue</button>
                    </div>
                </div>

                <div id="stone" class="tab-content">
                    <h3>Select Stone</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="stone-type">Stone Type</label>
                            <select id="stone-type">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('metal')">Back</button>
                        <button class="btn btn-primary" onclick="switchTab('weave')">Continue</button>
                    </div>
                </div>

                <div id="weave" class="tab-content">
                    <h3>Select Weaving</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="weave-material">Weaving Material</label>
                            <select id="weave-material">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('stone')">Back</button>
                        <button class="btn btn-primary" onclick="switchTab('carving')">Continue</button>
                    </div>
                </div>

                <div id="carving" class="tab-content">
                    <h3>Select Carving</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="carving-style">Carving Style</label>
                            <select id="carving-style">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('weave')">Back</button>
                        <button class="btn btn-primary" onclick="switchTab('additional')">Continue</button>
                    </div>
                </div>

                <div id="additional" class="tab-content">
                    <h3>Additional Specifications</h3>
                    <div class="form-group">
                        <label for="additional-specs">Additional Options</label>
                        <select id="additional-specs">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchTab('carving')">Back</button>
                        <button class="btn btn-primary" onclick="addItemToOrder()">Add Item to Order</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="order-items-section">
                    <div class="order-items-header">
                        <h3>Order Items</h3>
                        <div class="order-total">Total: $0.00</div>
                    </div>
                    
                    <div class="order-items-list" id="order-items-list">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                            <p>No items added yet</p>
                            <p style="font-size: 12px; margin-top: 10px;">Configure an item and add it to the order</p>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="submitOrder()" style="width: 100%;">
                            Submit Order for Production
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug" id="debug" style="display:none;"></div>
    </div>

    <script>
// Configuration
        const API_URL = 'https://rwfgdtwbzkglfljyvgbt.supabase.co/rest/v1';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3ZmdkdHdiemtnbGZsanl2Z2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDIwNjMsImV4cCI6MjA3MTU3ODA2M30.C3HRKtnQ_ivS7md7hJoOyusegbkusRCdhe5UonremY0';
        
        // Global state
        let orderItems = [];
        let currentItem = {};
        let itemsData = {};
        
        // Utility function for API calls
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_URL}/${endpoint}`, {
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }
        
        // Load collections on page load
        async function loadCollections() {
            console.log('Loading collections...');
            const data = await fetchData('collections?active=eq.true&order=collection_name');
            
            const select = document.getElementById('collection');
            if (!data || data.length === 0) {
                select.innerHTML = '<option value="">No collections available</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select Collection</option>';
            data.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection.collection_name;
                option.textContent = collection.collection_name;
                select.appendChild(option);
            });
            console.log(`Loaded ${data.length} collections`);
        }
        
        // Load items for selected collection
        async function loadItems() {
            const collection = document.getElementById('collection').value;
            const itemSelect = document.getElementById('item');
            
            if (!collection) {
                itemSelect.disabled = true;
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                return;
            }
            
            const data = await fetchData(`items?collection_name=eq.${encodeURIComponent(collection)}&active=eq.true&order=item_name`);
            
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            if (data && data.length > 0) {
                data.forEach(item => {
                    itemsData[item.base_sku] = {
                        name: item.item_name
                    };
                    const option = document.createElement('option');
                    option.value = item.base_sku;
                    option.textContent = item.item_name;
                    itemSelect.appendChild(option);
                });
                itemSelect.disabled = false;
            } else {
                itemSelect.innerHTML = '<option value="">No items available</option>';
            }
        }
        
        // Update price display
        function updateItemPrice() {
            const baseSku = document.getElementById('item').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const isRush = document.getElementById('rush').value === 'yes';
            
            if (baseSku && price > 0) {
                let totalPrice = price * quantity;
                if (isRush) {
                    totalPrice *= 1.25;
                }
                currentItem.basePrice = price;
                document.getElementById('item-price').textContent = `$${totalPrice.toFixed(2)}`;
            } else {
                document.getElementById('item-price').textContent = '$0.00';
            }
        }
        
        // Load fabric brands
        async function loadFabricBrands() {
            const data = await fetchData('fabric_brands?active=eq.true&order=brand_name');
            const select = document.getElementById('fabric-brand');
            select.innerHTML = '<option value="">Select Brand</option>';
            
            if (data && data.length > 0) {
                data.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.brand_name;
                    option.textContent = brand.brand_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load fabric collections for selected brand
        async function loadFabricCollections() {
            const brand = document.getElementById('fabric-brand').value;
            const collectionSelect = document.getElementById('fabric-collection');
            const colorSelect = document.getElementById('fabric-color');
            
            if (!brand) {
                collectionSelect.disabled = true;
                collectionSelect.innerHTML = '<option value="">Select Collection</option>';
                colorSelect.disabled = true;
                colorSelect.innerHTML = '<option value="">Select Color</option>';
                return;
            }
            
            const data = await fetchData(`fabric_collections?brand_name=eq.${encodeURIComponent(brand)}&active=eq.true&order=collection_name`);
            
            collectionSelect.innerHTML = '<option value="">Select Collection</option>';
            if (data && data.length > 0) {
                data.forEach(collection => {
                    const option = document.createElement('option');
                    option.value = collection.collection_id;
                    option.textContent = collection.collection_name;
                    collectionSelect.appendChild(option);
                });
                collectionSelect.disabled = false;
            }
        }
        
        // Load fabric colors for selected collection
        async function loadFabricColors() {
            const collectionId = document.getElementById('fabric-collection').value;
            const colorSelect = document.getElementById('fabric-color');
            
            if (!collectionId) {
                colorSelect.disabled = true;
                colorSelect.innerHTML = '<option value="">Select Color</option>';
                return;
            }
            
            const data = await fetchData(`fabric_colors?collection_id=eq.${collectionId}&active=eq.true&order=color_name`);
            
            colorSelect.innerHTML = '<option value="">Select Color</option>';
            if (data && data.length > 0) {
                data.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.color_name;
                    option.textContent = color.color_name;
                    colorSelect.appendChild(option);
                });
                colorSelect.disabled = false;
            }
        }
        
        // Load wood options
        async function loadWoodOptions() {
            const data = await fetchData('woods?active=eq.true&order=wood_name');
            const select = document.getElementById('wood-type');
            select.innerHTML = '<option value="">Select Wood</option>';
            
            if (data && data.length > 0) {
                data.forEach(wood => {
                    const option = document.createElement('option');
                    option.value = wood.wood_name;
                    option.textContent = wood.wood_name;
                    option.dataset.finishes = wood.finish_options || '';
                    select.appendChild(option);
                });
            }
        }
        
        // Load wood finishes for selected wood
        function loadWoodFinishes() {
            const select = document.getElementById('wood-type');
            const finishSelect = document.getElementById('wood-finish');
            finishSelect.innerHTML = '<option value="">Select Finish</option>';
            
            if (select.value) {
                const selectedOption = select.options[select.selectedIndex];
                const finishes = selectedOption.dataset.finishes.split(',');
                finishes.forEach(finish => {
                    if (finish.trim()) {
                        const option = document.createElement('option');
                        option.value = finish.trim();
                        option.textContent = finish.trim();
                        finishSelect.appendChild(option);
                    }
                });
            }
        }
        
        // Load metal options
        async function loadMetalOptions() {
            const data = await fetchData('metals?active=eq.true&order=metal_name');
            const select = document.getElementById('metal-type');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(metal => {
                    const option = document.createElement('option');
                    option.value = metal.metal_name;
                    option.textContent = metal.metal_name;
                    option.dataset.finishes = metal.finish_options || '';
                    select.appendChild(option);
                });
            }
        }
        
        // Load metal finishes for selected metal
        function loadMetalFinishes() {
            const select = document.getElementById('metal-type');
            const finishSelect = document.getElementById('metal-finish');
            finishSelect.innerHTML = '<option value="">Select Finish</option>';
            
            if (select.value) {
                const selectedOption = select.options[select.selectedIndex];
                const finishes = selectedOption.dataset.finishes.split(',');
                finishes.forEach(finish => {
                    if (finish.trim()) {
                        const option = document.createElement('option');
                        option.value = finish.trim();
                        option.textContent = finish.trim();
                        finishSelect.appendChild(option);
                    }
                });
            }
        }
        
        // Validate basic info
        function validateBasicInfo() {
            const collection = document.getElementById('collection').value;
            const item = document.getElementById('item').value;
            const price = document.getElementById('price').value;
            const quantity = document.getElementById('quantity').value;
            
            if (!collection || !item || !price || !quantity) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Save to current item
            currentItem = {
                collection: collection,
                item: itemsData[item]?.name || '',
                baseSku: item,
                basePrice: parseFloat(price),
                quantity: parseInt(quantity),
                rush: document.getElementById('rush').value === 'yes',
                notes: document.getElementById('notes').value,
                fabric: { brand: '', collection: '', color: '' },
                wood: { type: '', finish: '' },
                metal: { type: '', finish: '' }
            };
            
            // Enable material tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.disabled = false;
            });
            
            switchTab('fabric');
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName.replace('-', ' '))) {
                    tab.classList.add('active');
                }
            });
        }
        
        // Generate SKU (3-field system)
        function generateSKU(item) {
            const result = {
                base_sku: item.baseSku,
                custom_sku: '',
                sku_id: ''
            };
            
            // Build custom_sku (clean, readable code)
            const customParts = [item.baseSku];
            
            if (item.fabric.brand && item.fabric.color) {
                const brandCode = item.fabric.brand.substring(0, 3).toUpperCase();
                const collectionCode = item.fabric.collection.substring(0, 3).toUpperCase();
                const colorCode = item.fabric.color.substring(0, 3).toUpperCase();
                customParts.push(brandCode, collectionCode, colorCode);
            }
            
            if (item.wood.type) {
                const woodCode = item.wood.type.substring(0, 3).toUpperCase();
                customParts.push(woodCode);
                if (item.wood.finish) {
                    const finishCode = item.wood.finish.substring(0, 3).toUpperCase();
                    customParts.push(finishCode);
                }
            }
            
            if (item.metal.type) {
                const metalCode = item.metal.type.substring(0, 3).toUpperCase();
                customParts.push(metalCode);
            }
            
            result.custom_sku = customParts.join('-');
            
            // Generate unique sku_id for this order instance
            const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            result.sku_id = `SKU-${timestamp}-${random}`;
            
            return result;
        }

        // Add item to order
        function addItemToOrder() {
            // Collect material selections
            currentItem.fabric.brand = document.getElementById('fabric-brand').value;
            currentItem.fabric.collection = document.getElementById('fabric-collection').options[document.getElementById('fabric-collection').selectedIndex]?.text || '';
            currentItem.fabric.color = document.getElementById('fabric-color').value;
            
            currentItem.wood.type = document.getElementById('wood-type').value;
            currentItem.wood.finish = document.getElementById('wood-finish').value;
            
            currentItem.metal.type = document.getElementById('metal-type').value;
            currentItem.metal.finish = document.getElementById('metal-finish').value;
            
            // Generate SKU (3-field system)
            const skuData = generateSKU(currentItem);
            
            // Calculate price
            let itemPrice = currentItem.basePrice * currentItem.quantity;
            if (currentItem.rush) {
                itemPrice *= 1.25;
            }
            
            // Add to order items with all 3 SKU fields
            orderItems.push({
                ...currentItem,
                base_sku: skuData.base_sku,
                custom_sku: skuData.custom_sku,
                sku_id: skuData.sku_id,
                totalPrice: itemPrice
            });
            
            // Update display
            updateOrderItemsList();
            
            // Reset form
            resetForm();
            
            alert('Item added to order!');
        }

        // Update order items display
        function updateOrderItemsList() {
            const listContainer = document.getElementById('order-items-list');
            
            if (orderItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                        </svg>
                        <p>No items added yet</p>
                        <p style="font-size: 12px; margin-top: 10px;">Configure an item and add it to the order</p>
                    </div>
                `;
                document.querySelector('.order-total').textContent = 'Total: $0.00';
                return;
            }
            
            let html = '';
            let total = 0;
            
            orderItems.forEach((item, index) => {
                html += `
                    <div class="order-item">
                        <button class="remove-item" onclick="removeItem(${index})">×</button>
                        <div class="order-item-header">
                            <div>
                                <div class="order-item-title">${item.collection} - ${item.item}</div>
                                <div class="order-item-sku">${item.custom_sku}</div>
                            </div>
                            <div class="order-item-price">$${item.totalPrice.toFixed(2)}</div>
                        </div>
                        <div class="order-item-details">
                            <div>Quantity: ${item.quantity}</div>
                            <div>Unit Price: $${item.basePrice.toFixed(2)}</div>
                            ${item.fabric.color ? `<div>Fabric: ${item.fabric.color}</div>` : ''}
                            ${item.wood.type ? `<div>Wood: ${item.wood.type}</div>` : ''}
                            ${item.rush ? '<div style="color: #ff5252;">RUSH ORDER</div>' : ''}
                        </div>
                    </div>
                `;
                total += item.totalPrice;
            });
            
            listContainer.innerHTML = html;
            document.querySelector('.order-total').textContent = `Total: $${total.toFixed(2)}`;
        }

        // Remove item from order
        function removeItem(index) {
            if (confirm('Remove this item from the order?')) {
                orderItems.splice(index, 1);
                updateOrderItemsList();
            }
        }

// Reset form
function resetForm() {
    document.getElementById('collection').value = '';
    document.getElementById('item').value = '';
    document.getElementById('item').disabled = true;
    document.getElementById('price').value = '';
    document.getElementById('quantity').value = '1';
    document.getElementById('rush').value = 'no';
    document.getElementById('notes').value = '';
    document.getElementById('item-price').textContent = '$0.00';
    
    // Reset material selections
    document.getElementById('fabric-brand').value = '';
    document.getElementById('fabric-collection').value = '';
    document.getElementById('fabric-collection').disabled = true;
    document.getElementById('fabric-color').value = '';
    document.getElementById('fabric-color').disabled = true;
    
    document.getElementById('wood-type').value = '';
    document.getElementById('wood-finish').value = '';
    
    document.getElementById('metal-type').value = '';
    document.getElementById('metal-finish').value = '';
    
    // Reset additional material selections
    document.getElementById('stone-type').value = '';
    document.getElementById('weave-material').value = '';
    document.getElementById('carving-style').value = '';
    document.getElementById('additional-specs').value = '';
    
    // Disable material tabs
    document.querySelectorAll('.tab').forEach(tab => {
        if (!tab.textContent.includes('Item Details')) {
            tab.disabled = true;
        }
    });
    
    // Switch back to basic info
    switchTab('basic-info');
    
    // Reset currentItem
    currentItem = {};
}

        // Submit order
async function submitOrder() {
    if (orderItems.length === 0) {
        alert('Please add at least one item to the order');
        return;
    }
    
    if (!confirm(`Submit ${orderItems.length} items for production?`)) {
        return;
    }
    
    // Make.com webhook URL - REPLACE WITH YOUR ACTUAL WEBHOOK URL
    const WEBHOOK_URL = 'https://hook.us2.make.com/ue47c6ub3xk6b2hrpfejncrccjuetxuh';
    
    try {
        // Send each item to webhook
        for (const item of orderItems) {
            const webhookData = {
                custom_sku: item.custom_sku,
                base_sku: item.base_sku,
                sku_id: item.sku_id,
                collection: item.collection,
                item_name: item.item,
                fabric_brand: item.fabric.brand || "",
                fabric_collection: item.fabric.collection || "",
                fabric_color: item.fabric.color || "",
                wood: item.wood.type ? `${item.wood.type}${item.wood.finish ? ' ' + item.wood.finish : ''}` : "",
                metal: item.metal.type || "",
                status: "Pending",
                project_name: document.getElementById('project-name')?.textContent || '',
                client_name: document.getElementById('client-name')?.textContent || '',
                final_price: item.totalPrice,
                quantity: item.quantity,
                notes: item.notes || '',
                order_id: document.getElementById('order-id')?.textContent || '',
                date_created: new Date().toISOString()
            };
            
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(webhookData)
            });
            
            if (!response.ok) {
                throw new Error(`Webhook failed: ${response.status}`);
            }
        }
        
        alert(`Order submitted successfully! ${orderItems.length} SKUs sent to production system.`);
        orderItems = [];
        updateOrderItemsList();
        resetForm();
        
    } catch (error) {
        console.error('Error submitting order:', error);
        alert('Error submitting order. Please check console for details.');
    }
}
                    
                    // Remove empty strings
                    Object.keys(columnValues).forEach(key => {
                        if (columnValues[key] === "") {
                            delete columnValues[key];
                        }
                    });
                    
                    const mutation = `
                        mutation {
                            create_item(
                                board_id: ${BOARD_ID},
                                item_name: "${item.custom_sku}",
                                column_values: ${JSON.stringify(JSON.stringify(columnValues))}
                            ) {
                                id
                            }
                        }
                    `;
                    
                    const response = await fetch('https://api.monday.com/v2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': MONDAY_API_TOKEN
                        },
                        body: JSON.stringify({ query: mutation })
                    });
                    
                    const result = await response.json();
                    if (result.errors) {
                        console.error('Monday.com error:', result.errors);
                        throw new Error('Failed to create item in Monday.com');
                    }
                }
                
                alert(`Order submitted successfully! ${orderItems.length} SKUs created in Monday.com.`);
                orderItems = [];
                updateOrderItemsList();
                resetForm();
                
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Error submitting order. Please check console for details.');
            }
        }
        
        // Load stone options
        async function loadStoneOptions() {
            const data = await fetchData('stones?active=eq.true&order=stone_name');
            const select = document.getElementById('stone-type');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(stone => {
                    const option = document.createElement('option');
                    option.value = stone.stone_name;
                    option.textContent = stone.stone_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load weaving materials
        async function loadWeavingMaterials() {
            const data = await fetchData('weaving_materials?active=eq.true&order=material_name');
            const select = document.getElementById('weave-material');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(weave => {
                    const option = document.createElement('option');
                    option.value = weave.material_name;
                    option.textContent = weave.material_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load carving options
        async function loadCarvingOptions() {
            const data = await fetchData('carvings?active=eq.true&order=carving_name');
            const select = document.getElementById('carving-style');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(carving => {
                    const option = document.createElement('option');
                    option.value = carving.carving_name;
                    option.textContent = carving.carving_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load additional specs
        async function loadAdditionalSpecs() {
            const data = await fetchData('additional_specs?active=eq.true&order=spec_name');
            const select = document.getElementById('additional-specs');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec.spec_name;
                    option.textContent = spec.spec_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing form...');
            await loadCollections();
            await loadFabricBrands();
            await loadWoodOptions();
            await loadMetalOptions();
            await loadStoneOptions();
            await loadWeavingMaterials();
            await loadCarvingOptions();
            await loadAdditionalSpecs();
            console.log('Form ready');
        });
    </script>
</body>
</html>