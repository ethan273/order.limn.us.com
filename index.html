<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limn Order Form - Add Order Items</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .order-info-bar {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .order-info-item {
            display: flex;
            flex-direction: column;
            margin-right: 30px;
        }

        .order-info-item label {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 5px;
        }

        .order-info-item span {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 600px;
        }

        .left-panel {
            padding: 30px;
            border-right: 2px solid #e0e0e0;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .right-panel {
            background: #f8f9fa;
            padding: 30px;
        }

        .section {
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .section.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled,
        .form-group select:disabled,
        .form-group textarea:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .price-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .price-display .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .price-display .value {
            font-size: 28px;
            font-weight: bold;
        }

        .order-items-section {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .order-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .order-items-header h3 {
            font-size: 18px;
            color: #333;
        }

        .order-total {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .order-items-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .order-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .order-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .order-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .order-item-sku {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .order-item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
            color: #666;
        }

        .order-item-price {
            text-align: right;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .remove-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: all 0.3s;
        }

        .remove-item:hover {
            background: #ff1744;
            transform: scale(1.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .required-indicator {
            color: #ff5252;
            margin-left: 2px;
        }

        .optional-badge {
            display: inline-block;
            background: #f0f0f0;
            color: #666;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            font-weight: normal;
        }

        /* Custom scrollbar for left panel */
        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .left-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Add Order Items</h1>
            <p>Configure furniture items for this order</p>
        </div>

        <div class="order-info-bar">
            <div class="order-info-item">
                <label>Order ID</label>
                <span id="order-id">ORD-2025-001</span>
            </div>
            <div class="order-info-item">
                <label>Client</label>
                <span id="client-name">Test Client</span>
            </div>
            <div class="order-info-item">
                <label>Project</label>
                <span id="project-name">Test Project</span>
            </div>
            <div class="order-info-item">
                <label>Created Date</label>
                <span id="order-date">2025-01-01</span>
            </div>
            <div class="order-info-item">
                <label>Status</label>
                <span id="order-status">Draft</span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <!-- Section 1: Item Selection -->
                <div class="section" id="item-section">
                    <div class="section-header">
                        <div class="section-number">1</div>
                        <div class="section-title">Select Item</div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="collection">Collection <span class="required-indicator">*</span></label>
                            <select id="collection" required onchange="loadItems()">
                                <option value="">Loading collections...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item">Item <span class="required-indicator">*</span></label>
                            <select id="item" required disabled onchange="onItemSelected()">
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="price">Price <span class="required-indicator">*</span></label>
                            <input type="number" id="price" min="0" step="0.01" placeholder="Enter price" required onchange="updateItemPrice()">
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity <span class="required-indicator">*</span></label>
                            <input type="number" id="quantity" min="1" value="1" required onchange="updateItemPrice()">
                        </div>
                        <div class="form-group">
                            <label for="rush">Rush Order</label>
                            <select id="rush" onchange="updateItemPrice()">
                                <option value="no">No</option>
                                <option value="yes">Yes (+25%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="price-display">
                        <div class="label">Item Price</div>
                        <div class="value" id="item-price">$0.00</div>
                    </div>

                    <button class="btn btn-primary" onclick="validateAndEnableMaterials()" id="enable-materials-btn">
                        Continue to Material Selection
                    </button>
                </div>

                <!-- Section 2: Fabric Selection -->
                <div class="section disabled" id="fabric-section">
                    <div class="section-header">
                        <div class="section-number">2</div>
                        <div class="section-title">Fabric Selection <span class="optional-badge">Optional</span></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fabric-brand">Fabric Brand</label>
                            <select id="fabric-brand" onchange="loadFabricCollections()" disabled>
                                <option value="">None / Select Brand</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fabric-collection">Fabric Collection</label>
                            <select id="fabric-collection" onchange="loadFabricColors()" disabled>
                                <option value="">Select Collection</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fabric-color">Fabric Color</label>
                            <select id="fabric-color" disabled>
                                <option value="">Select Color</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Wood Selection -->
                <div class="section disabled" id="wood-section">
                    <div class="section-header">
                        <div class="section-number">3</div>
                        <div class="section-title">Wood Selection <span class="optional-badge">Optional</span></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="wood-type">Wood Type</label>
                            <select id="wood-type" onchange="loadWoodFinishes()" disabled>
                                <option value="">None / Select Wood</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="wood-finish">Wood Finish</label>
                            <select id="wood-finish" disabled>
                                <option value="">Select Finish</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Metal Selection -->
                <div class="section disabled" id="metal-section">
                    <div class="section-header">
                        <div class="section-number">4</div>
                        <div class="section-title">Metal Selection <span class="optional-badge">Optional</span></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="metal-type">Metal Type</label>
                            <select id="metal-type" onchange="loadMetalFinishes()" disabled>
                                <option value="">None / Select Metal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="metal-finish">Metal Finish</label>
                            <select id="metal-finish" disabled>
                                <option value="">Select Finish</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Additional Materials -->
                <div class="section disabled" id="additional-section">
                    <div class="section-header">
                        <div class="section-number">5</div>
                        <div class="section-title">Additional Materials <span class="optional-badge">Optional</span></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="stone-type">Stone Type</label>
                            <select id="stone-type" disabled>
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="weave-material">Weaving Material</label>
                            <select id="weave-material" disabled>
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="carving-style">Carving Style</label>
                            <select id="carving-style" disabled>
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Notes and Final Details -->
                <div class="section disabled" id="notes-section">
                    <div class="section-header">
                        <div class="section-number">6</div>
                        <div class="section-title">Additional Specifications</div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: span 2;">
                            <label for="additional-specs">Additional Options</label>
                            <select id="additional-specs" disabled>
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Item Notes</label>
                        <textarea id="notes" placeholder="Special instructions for this item..." disabled></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
                        <button class="btn btn-primary" onclick="addItemToOrder()" id="add-item-btn" disabled>
                            Add Item to Order
                        </button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="order-items-section">
                    <div class="order-items-header">
                        <h3>Order Items</h3>
                        <div class="order-total">Total: $0.00</div>
                    </div>
                    
                    <div class="order-items-list" id="order-items-list">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                            <p>No items added yet</p>
                            <p style="font-size: 12px; margin-top: 10px;">Configure an item and add it to the order</p>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="submitOrder()" style="width: 100%;">
                            Submit Order for Production
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://rwfgdtwbzkglfljyvgbt.supabase.co/rest/v1';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3ZmdkdHdiemtnbGZsanl2Z2J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDIwNjMsImV4cCI6MjA3MTU3ODA2M30.C3HRKtnQ_ivS7md7hJoOyusegbkusRCdhe5UonremY0';
        
        // Global state
        let orderItems = [];
        let currentItem = {};
        let itemsData = {};
        let materialsEnabled = false;
        
        // Utility function for API calls
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_URL}/${endpoint}`, {
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }
        
        // Load collections on page load
        async function loadCollections() {
            console.log('Loading collections...');
            const data = await fetchData('collections?active=eq.true&order=collection_name');
            
            const select = document.getElementById('collection');
            
            if (!data || data.length === 0) {
                select.innerHTML = '<option value="">No collections available</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select Collection</option>';
            data.forEach((collection) => {
                const option = document.createElement('option');
                option.value = collection.collection_name;
                option.textContent = collection.collection_name;
                select.appendChild(option);
            });
            console.log('Collections loaded successfully');
        }
        
        // Load items for selected collection with pricing
        async function loadItems() {
            const collection = document.getElementById('collection').value;
            const itemSelect = document.getElementById('item');
            
            if (!collection) {
                itemSelect.disabled = true;
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                return;
            }
            
            // Updated query to get base_price and lead_time_days
            const data = await fetchData(`items?collection_name=eq.${encodeURIComponent(collection)}&active=eq.true&select=item_id,item_name,base_sku,base_price,estimated_lead_time_days&order=item_name`);
            
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            if (data && data.length > 0) {
                data.forEach(item => {
                    itemsData[item.base_sku] = {
                        name: item.item_name,
                        basePrice: item.base_price,
                        leadTime: item.estimated_lead_time_days || 30
                    };
                    const option = document.createElement('option');
                    option.value = item.base_sku;
                    option.textContent = item.base_price ? 
                        `${item.item_name} ($${parseFloat(item.base_price).toFixed(2)})` : 
                        item.item_name;
                    itemSelect.appendChild(option);
                });
                itemSelect.disabled = false;
            } else {
                itemSelect.innerHTML = '<option value="">No items available</option>';
            }
        }
        
        // Auto-populate price when item selected
        function onItemSelected() {
            const baseSku = document.getElementById('item').value;
            const priceInput = document.getElementById('price');
            
            if (baseSku && itemsData[baseSku] && itemsData[baseSku].basePrice) {
                priceInput.value = itemsData[baseSku].basePrice;
                updateItemPrice();
            }
        }
        
        // Update price display
        function updateItemPrice() {
            const baseSku = document.getElementById('item').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const isRush = document.getElementById('rush').value === 'yes';
            
            if (baseSku && price > 0) {
                let totalPrice = price * quantity;
                if (isRush) {
                    totalPrice *= 1.25;
                }
                currentItem.basePrice = price;
                document.getElementById('item-price').textContent = `$${totalPrice.toFixed(2)}`;
            } else {
                document.getElementById('item-price').textContent = '$0.00';
            }
        }
        
        // Validate and enable materials
        function validateAndEnableMaterials() {
            const collection = document.getElementById('collection').value;
            const item = document.getElementById('item').value;
            const price = document.getElementById('price').value;
            const quantity = document.getElementById('quantity').value;
            
            if (!collection || !item || !price || !quantity) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Save to current item
            currentItem = {
                collection: collection,
                item: itemsData[item]?.name || '',
                baseSku: item,
                basePrice: parseFloat(price),
                quantity: parseInt(quantity),
                rush: document.getElementById('rush').value === 'yes',
                notes: document.getElementById('notes').value,
                fabric: { brand: '', collection: '', color: '' },
                wood: { type: '', finish: '' },
                metal: { type: '', finish: '' },
                stone: { type: '' },
                weave: { material: '' },
                carving: { style: '' },
                additionalSpecs: ''
            };
            
            // Enable material sections
            enableMaterialSections();
            
            // Hide the continue button and scroll to fabric section
            document.getElementById('enable-materials-btn').style.display = 'none';
            document.getElementById('fabric-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Enable all material sections
        function enableMaterialSections() {
            materialsEnabled = true;
            
            // Enable all sections
            document.querySelectorAll('.section.disabled').forEach(section => {
                section.classList.remove('disabled');
            });
            
            // Enable all form inputs in material sections
            document.getElementById('fabric-brand').disabled = false;
            document.getElementById('wood-type').disabled = false;
            document.getElementById('metal-type').disabled = false;
            document.getElementById('stone-type').disabled = false;
            document.getElementById('weave-material').disabled = false;
            document.getElementById('carving-style').disabled = false;
            document.getElementById('additional-specs').disabled = false;
            document.getElementById('notes').disabled = false;
            document.getElementById('add-item-btn').disabled = false;
        }
        
        // Load fabric brands
        async function loadFabricBrands() {
            const data = await fetchData('fabric_brands?active=eq.true&order=brand_name');
            const select = document.getElementById('fabric-brand');
            select.innerHTML = '<option value="">None / Select Brand</option>';
            
            if (data && data.length > 0) {
                data.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.brand_name;
                    option.textContent = brand.brand_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load fabric collections for selected brand
        async function loadFabricCollections() {
            const brand = document.getElementById('fabric-brand').value;
            const collectionSelect = document.getElementById('fabric-collection');
            const colorSelect = document.getElementById('fabric-color');
            
            if (!brand) {
                collectionSelect.disabled = true;
                collectionSelect.innerHTML = '<option value="">Select Collection</option>';
                colorSelect.disabled = true;
                colorSelect.innerHTML = '<option value="">Select Color</option>';
                return;
            }
            
            const data = await fetchData(`fabric_collections?brand_name=eq.${encodeURIComponent(brand)}&active=eq.true&order=collection_name`);
            
            collectionSelect.innerHTML = '<option value="">Select Collection</option>';
            if (data && data.length > 0) {
                data.forEach(collection => {
                    const option = document.createElement('option');
                    option.value = collection.collection_id;
                    option.textContent = collection.collection_name;
                    option.dataset.collectionName = collection.collection_name;
                    collectionSelect.appendChild(option);
                });
                collectionSelect.disabled = false;
            }
        }
        
        // Load fabric colors for selected collection
        async function loadFabricColors() {
            const collectionId = document.getElementById('fabric-collection').value;
            const colorSelect = document.getElementById('fabric-color');
            
            if (!collectionId) {
                colorSelect.disabled = true;
                colorSelect.innerHTML = '<option value="">Select Color</option>';
                return;
            }
            
            const data = await fetchData(`fabric_colors?collection_id=eq.${collectionId}&active=eq.true&order=color_name`);
            
            colorSelect.innerHTML = '<option value="">Select Color</option>';
            if (data && data.length > 0) {
                data.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.color_name;
                    option.textContent = color.color_name;
                    colorSelect.appendChild(option);
                });
                colorSelect.disabled = false;
            }
        }
        
        // Load wood options
        async function loadWoodOptions() {
            const data = await fetchData('woods?active=eq.true&order=wood_name');
            const select = document.getElementById('wood-type');
            select.innerHTML = '<option value="">None / Select Wood</option>';
            
            if (data && data.length > 0) {
                data.forEach(wood => {
                    const option = document.createElement('option');
                    option.value = wood.wood_name;
                    option.textContent = wood.wood_name;
                    option.dataset.finishes = wood.finish_options || '';
                    select.appendChild(option);
                });
            }
        }
        
        // Load wood finishes for selected wood
        function loadWoodFinishes() {
            const select = document.getElementById('wood-type');
            const finishSelect = document.getElementById('wood-finish');
            finishSelect.innerHTML = '<option value="">Select Finish</option>';
            
            if (select.value) {
                const selectedOption = select.options[select.selectedIndex];
                const finishes = selectedOption.dataset.finishes;
                if (finishes) {
                    finishes.split(',').forEach(finish => {
                        if (finish.trim()) {
                            const option = document.createElement('option');
                            option.value = finish.trim();
                            option.textContent = finish.trim();
                            finishSelect.appendChild(option);
                        }
                    });
                    finishSelect.disabled = false;
                } else {
                    finishSelect.disabled = true;
                }
            } else {
                finishSelect.disabled = true;
            }
        }
        
        // Load metal options
        async function loadMetalOptions() {
            const data = await fetchData('metals?active=eq.true&order=metal_name');
            const select = document.getElementById('metal-type');
            select.innerHTML = '<option value="">None / Select Metal</option>';
            
            if (data && data.length > 0) {
                data.forEach(metal => {
                    const option = document.createElement('option');
                    option.value = metal.metal_name;
                    option.textContent = metal.metal_name;
                    option.dataset.finishes = metal.finish_options || '';
                    select.appendChild(option);
                });
            }
        }
        
        // Load metal finishes for selected metal
        function loadMetalFinishes() {
            const select = document.getElementById('metal-type');
            const finishSelect = document.getElementById('metal-finish');
            finishSelect.innerHTML = '<option value="">Select Finish</option>';
            
            if (select.value) {
                const selectedOption = select.options[select.selectedIndex];
                const finishes = selectedOption.dataset.finishes;
                if (finishes) {
                    finishes.split(',').forEach(finish => {
                        if (finish.trim()) {
                            const option = document.createElement('option');
                            option.value = finish.trim();
                            option.textContent = finish.trim();
                            finishSelect.appendChild(option);
                        }
                    });
                    finishSelect.disabled = false;
                } else {
                    finishSelect.disabled = true;
                }
            } else {
                finishSelect.disabled = true;
            }
        }
        
        // Generate SKU
        function generateSKU(item) {
            const result = {
                base_sku: item.baseSku,
                custom_sku: '',
                sku_id: ''
            };
            
            // Build custom_sku
            const customParts = [item.baseSku];
            
            if (item.fabric.brand && item.fabric.color) {
                const brandCode = item.fabric.brand.substring(0, 3).toUpperCase();
                const collectionCode = item.fabric.collection.substring(0, 3).toUpperCase();
                const colorCode = item.fabric.color.substring(0, 3).toUpperCase();
                customParts.push(brandCode, collectionCode, colorCode);
            }
            
            if (item.wood.type) {
                const woodCode = item.wood.type.substring(0, 3).toUpperCase();
                customParts.push(woodCode);
                if (item.wood.finish) {
                    const finishCode = item.wood.finish.substring(0, 3).toUpperCase();
                    customParts.push(finishCode);
                }
            }
            
            if (item.metal.type) {
                const metalCode = item.metal.type.substring(0, 3).toUpperCase();
                customParts.push(metalCode);
            }
            
            result.custom_sku = customParts.join('-');
            
            // Generate unique sku_id for this order instance
            const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            result.sku_id = `SKU-${timestamp}-${random}`;
            
            return result;
        }

        // Add item to order
        function addItemToOrder() {
            // Make sure we have the basic item info
            if (!currentItem.baseSku) {
                alert('Please complete item selection first');
                return;
            }
            
            // Collect material selections
            currentItem.fabric.brand = document.getElementById('fabric-brand').value;
            const collectionSelect = document.getElementById('fabric-collection');
            currentItem.fabric.collection = collectionSelect.options[collectionSelect.selectedIndex]?.dataset?.collectionName || 
                                           collectionSelect.options[collectionSelect.selectedIndex]?.text || '';
            currentItem.fabric.color = document.getElementById('fabric-color').value;
            
            currentItem.wood.type = document.getElementById('wood-type').value;
            currentItem.wood.finish = document.getElementById('wood-finish').value;
            
            currentItem.metal.type = document.getElementById('metal-type').value;
            currentItem.metal.finish = document.getElementById('metal-finish').value;
            
            currentItem.stone.type = document.getElementById('stone-type').value;
            currentItem.weave.material = document.getElementById('weave-material').value;
            currentItem.carving.style = document.getElementById('carving-style').value;
            currentItem.additionalSpecs = document.getElementById('additional-specs').value;
            currentItem.notes = document.getElementById('notes').value;
            
            // Generate SKU
            const skuData = generateSKU(currentItem);
            
            // Calculate price
            let itemPrice = currentItem.basePrice * currentItem.quantity;
            if (currentItem.rush) {
                itemPrice *= 1.25;
            }
            
            // Add to order items with all fields
            orderItems.push({
                ...currentItem,
                base_sku: skuData.base_sku,
                custom_sku: skuData.custom_sku,
                sku_id: skuData.sku_id,
                totalPrice: itemPrice
            });
            
            // Update display
            updateOrderItemsList();
            
            // Reset form
            resetForm();
            
            alert('Item added to order!');
        }

        // Update order items display
        function updateOrderItemsList() {
            const listContainer = document.getElementById('order-items-list');
            
            if (orderItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                        </svg>
                        <p>No items added yet</p>
                        <p style="font-size: 12px; margin-top: 10px;">Configure an item and add it to the order</p>
                    </div>
                `;
                document.querySelector('.order-total').textContent = 'Total: $0.00';
                return;
            }
            
            let html = '';
            let total = 0;
            
            orderItems.forEach((item, index) => {
                html += `
                    <div class="order-item">
                        <button class="remove-item" onclick="removeItem(${index})">Ã—</button>
                        <div class="order-item-header">
                            <div>
                                <div class="order-item-title">${item.collection} - ${item.item}</div>
                                <div class="order-item-sku">${item.custom_sku}</div>
                            </div>
                            <div class="order-item-price">$${item.totalPrice.toFixed(2)}</div>
                        </div>
                        <div class="order-item-details">
                            <div>Quantity: ${item.quantity}</div>
                            <div>Unit Price: $${item.basePrice.toFixed(2)}</div>
                            ${item.fabric.color ? `<div>Fabric: ${item.fabric.color}</div>` : ''}
                            ${item.wood.type ? `<div>Wood: ${item.wood.type}</div>` : ''}
                            ${item.rush ? '<div style="color: #ff5252;">RUSH ORDER</div>' : ''}
                        </div>
                    </div>
                `;
                total += item.totalPrice;
            });
            
            listContainer.innerHTML = html;
            document.querySelector('.order-total').textContent = `Total: $${total.toFixed(2)}`;
        }

        // Remove item from order
        function removeItem(index) {
            if (confirm('Remove this item from the order?')) {
                orderItems.splice(index, 1);
                updateOrderItemsList();
            }
        }

        // Reset form
        function resetForm() {
            // Reset item selection
            document.getElementById('collection').value = '';
            document.getElementById('item').value = '';
            document.getElementById('item').disabled = true;
            document.getElementById('price').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('rush').value = 'no';
            document.getElementById('notes').value = '';
            document.getElementById('item-price').textContent = '$0.00';
            
            // Reset material selections
            document.getElementById('fabric-brand').value = '';
            document.getElementById('fabric-collection').value = '';
            document.getElementById('fabric-collection').disabled = true;
            document.getElementById('fabric-color').value = '';
            document.getElementById('fabric-color').disabled = true;
            
            document.getElementById('wood-type').value = '';
            document.getElementById('wood-finish').value = '';
            document.getElementById('wood-finish').disabled = true;
            
            document.getElementById('metal-type').value = '';
            document.getElementById('metal-finish').value = '';
            document.getElementById('metal-finish').disabled = true;
            
            document.getElementById('stone-type').value = '';
            document.getElementById('weave-material').value = '';
            document.getElementById('carving-style').value = '';
            document.getElementById('additional-specs').value = '';
            
            // Disable material sections again
            document.querySelectorAll('.section').forEach((section, index) => {
                if (index > 0) { // Skip the first section (item selection)
                    section.classList.add('disabled');
                }
            });
            
            // Re-disable material inputs
            document.getElementById('fabric-brand').disabled = true;
            document.getElementById('wood-type').disabled = true;
            document.getElementById('metal-type').disabled = true;
            document.getElementById('stone-type').disabled = true;
            document.getElementById('weave-material').disabled = true;
            document.getElementById('carving-style').disabled = true;
            document.getElementById('additional-specs').disabled = true;
            document.getElementById('notes').disabled = true;
            document.getElementById('add-item-btn').disabled = true;
            
            // Show the continue button again
            document.getElementById('enable-materials-btn').style.display = 'block';
            
            // Reset current item
            currentItem = {};
            materialsEnabled = false;
            
            // Scroll back to top
            document.getElementById('item-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Submit order
        async function submitOrder() {
            if (orderItems.length === 0) {
                alert('Please add at least one item to the order');
                return;
            }
            
            if (!confirm(`Submit ${orderItems.length} items for production?`)) {
                return;
            }
            
            // Make.com webhook URL
            const WEBHOOK_URL = 'https://hook.us2.make.com/ue47c6ub3xk6b2hrpfejncrccjuetxuh';
            
            try {
                // Send each item to webhook
                for (const item of orderItems) {
                    // Prepare data matching Monday board columns exactly
                    const webhookData = {
                        // SKU identifiers (matching SKU Registry board)
                        custom_sku: item.custom_sku,
                        base_sku: item.base_sku,
                        sku_id: item.sku_id,
                        
                        // Item details
                        collection: item.collection,
                        item_name: item.item,
                        
                        // Materials (matching board field names)
                        fabric_brand: item.fabric.brand || "",
                        fabric_collection: item.fabric.collection || "",
                        fabric_color: item.fabric.color || "",
                        wood_type: item.wood.type ? `${item.wood.type}${item.wood.finish ? ' ' + item.wood.finish : ''}` : "",
                        metal_type: item.metal.type || "",
                        stone_type: item.stone.type || "",
                        carving_style: item.carving.style || "",
                        weaving_material: item.weave.material || "",
                        additional_specs: item.additionalSpecs || "",
                        
                        // Order details
                        quantity: item.quantity,
                        final_price: item.totalPrice,
                        rush_order: item.rush ? "Yes" : "No",
                        
                        // Context
                        client_name: document.getElementById('client-name').textContent,
                        order_number: document.getElementById('order-id').textContent,
                        project_id: document.getElementById('project-name').textContent,
                        notes: item.notes || '',
                        
                        // Status
                        production_status: "Working on it",
                        
                        // Timestamp
                        date_created: new Date().toISOString()
                    };
                    
                    console.log('Sending webhook:', webhookData);
                    
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(webhookData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Webhook failed: ${response.status}`);
                    }
                }
                
                alert(`Order submitted successfully! ${orderItems.length} SKUs sent to production system.`);
                orderItems = [];
                updateOrderItemsList();
                resetForm();
                
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Error submitting order. Please check console for details.');
            }
        }
        
        // Load stone options
        async function loadStoneOptions() {
            const data = await fetchData('stones?active=eq.true&order=stone_name');
            const select = document.getElementById('stone-type');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(stone => {
                    const option = document.createElement('option');
                    option.value = stone.stone_name;
                    option.textContent = stone.stone_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load weaving materials
        async function loadWeavingMaterials() {
            const data = await fetchData('weaving_materials?active=eq.true&order=material_name');
            const select = document.getElementById('weave-material');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(weave => {
                    const option = document.createElement('option');
                    option.value = weave.material_name;
                    option.textContent = weave.material_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load carving options
        async function loadCarvingOptions() {
            const data = await fetchData('carvings?active=eq.true&order=carving_name');
            const select = document.getElementById('carving-style');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(carving => {
                    const option = document.createElement('option');
                    option.value = carving.carving_name;
                    option.textContent = carving.carving_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load additional specs
        async function loadAdditionalSpecs() {
            const data = await fetchData('additional_specs?active=eq.true&order=spec_name');
            const select = document.getElementById('additional-specs');
            select.innerHTML = '<option value="">None</option>';
            
            if (data && data.length > 0) {
                data.forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec.spec_name;
                    option.textContent = spec.spec_name;
                    select.appendChild(option);
                });
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing form...');
            await loadCollections();
            await loadFabricBrands();
            await loadWoodOptions();
            await loadMetalOptions();
            await loadStoneOptions();
            await loadWeavingMaterials();
            await loadCarvingOptions();
            await loadAdditionalSpecs();
            console.log('Form ready');
        });
    </script>
</body>
</html>